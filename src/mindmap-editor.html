<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Map Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #mindMapContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #mindMapContainer * {
            margin: 0;
            padding: 0;
        }
        
        .toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 8px;
            display: flex;
            gap: 8px;
        }
        
        .toolbar button {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .toolbar button:hover {
            background: #f5f5f5;
            border-color: #40a9ff;
        }
        
        .toolbar button:active {
            background: #e6e6e6;
        }
        
        body.dark {
            background: #1e1e1e;
        }
        
        body.dark .toolbar {
            background: #2d2d2d;
            border-color: #3d3d3d;
        }
        
        body.dark .toolbar button {
            background: #2d2d2d;
            color: #e0e0e0;
            border-color: #3d3d3d;
        }
        
        body.dark .toolbar button:hover {
            background: #3d3d3d;
            border-color: #4d4d4d;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="saveBtn">Save</button>
        <button id="exportBtn">Export</button>
        <button id="resetBtn">Reset View</button>
    </div>
    <div id="mindMapContainer"></div>
    
    <script type="module">
        import MindMap from 'simple-mind-map';
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const isDark = urlParams.get('dark') === '1';
        const iframeID = urlParams.get('iframeID');
        
        // Apply dark mode
        if (isDark) {
            document.body.classList.add('dark');
        }
        
        // Initialize mind map
        let mindMapInstance = null;
        let currentData = null;
        
        function initMindMap(data) {
            const container = document.getElementById('mindMapContainer');
            
            // Clear existing instance
            if (mindMapInstance) {
                mindMapInstance.destroy();
            }
            
            mindMapInstance = new MindMap({
                el: container,
                data: data || {
                    data: {
                        text: '根节点'
                    },
                    children: []
                },
                // Configuration
                layout: 'logicalStructure',
                theme: isDark ? 'dark' : 'default',
                readonly: false,
            });
            
            currentData = data;
            
            // Listen to data changes
            mindMapInstance.on('data_change', (data) => {
                currentData = data;
            });
            
            // Send init event
            sendMessage({
                event: 'init'
            });
        }
        
        // Message handling
        function sendMessage(message) {
            if (window.parent) {
                window.parent.postMessage(JSON.stringify(message), '*');
            }
        }
        
        function handleMessage(event) {
            try {
                const message = JSON.parse(event.data);
                
                if (message.action === 'load') {
                    // Load mind map data
                    const data = message.data ? JSON.parse(message.data) : null;
                    initMindMap(data);
                } else if (message.action === 'export') {
                    // Export mind map
                    const format = message.format || 'png';
                    exportMindMap(format);
                } else if (message.action === 'getData') {
                    // Get current data
                    sendMessage({
                        event: 'data',
                        data: JSON.stringify(mindMapInstance.getData())
                    });
                }
            } catch (err) {
                console.error('Message handling error:', err);
            }
        }
        
        async function exportMindMap(format) {
            try {
                let exportData;
                
                if (format === 'png') {
                    exportData = await mindMapInstance.export('png', false, 'mindmap');
                } else if (format === 'svg') {
                    exportData = await mindMapInstance.export('svg', false, 'mindmap');
                } else if (format === 'json') {
                    exportData = JSON.stringify(mindMapInstance.getData(true));
                }
                
                sendMessage({
                    event: 'export',
                    format: format,
                    data: exportData
                });
            } catch (err) {
                console.error('Export error:', err);
                sendMessage({
                    event: 'error',
                    message: err.message
                });
            }
        }
        
        // Toolbar button handlers
        document.getElementById('saveBtn').addEventListener('click', () => {
            sendMessage({
                event: 'save',
                data: JSON.stringify(mindMapInstance.getData(true))
            });
        });
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            sendMessage({
                event: 'export_request'
            });
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (mindMapInstance) {
                mindMapInstance.view.reset();
            }
        });
        
        // Listen for messages from parent
        window.addEventListener('message', handleMessage);
        
        // Initialize with default data
        initMindMap(null);
    </script>
</body>
</html>
