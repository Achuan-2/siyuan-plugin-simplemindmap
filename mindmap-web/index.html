<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <link rel="icon" href="dist/logo.ico">
    <title>思维导图</title>
    <script>
        // 自定义静态资源的路径
        window.externalPublicPath = './dist/'
        // 接管应用
        window.takeOverApp = true
    </script>
    <link href="dist/css/chunk-vendors.css" rel="stylesheet">
    <link href="dist/css/app.css" rel="stylesheet">
</head>
<body>
    <noscript>
        <strong>We're sorry but thoughts doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <script>
        // 从父窗口获取数据
        const getDataFromParent = () => {
            return new Promise((resolve, reject) => {
                // 发送消息给父窗口请求数据
                window.parent.postMessage(JSON.stringify({
                    event: 'request_data'
                }), '*');
                
                // 监听父窗口的响应
                const messageHandler = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.event === 'init_data') {
                            window.removeEventListener('message', messageHandler);
                            resolve({
                                mindMapData: message.mindMapData || {
                                    root: {
                                        data: {
                                            text: '根节点'
                                        },
                                        children: []
                                    },
                                    theme: {
                                        template: 'avocado',
                                        config: {}
                                    },
                                    layout: 'logicalStructure',
                                    config: {},
                                    view: null
                                },
                                mindMapConfig: message.mindMapConfig || {},
                                lang: message.lang || 'zh',
                                localConfig: message.localConfig || null
                            });
                        }
                    } catch (err) {
                        console.error('Parse message error:', err);
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // 超时处理
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    resolve({
                        mindMapData: {
                            root: {
                                data: {
                                    text: '根节点'
                                },
                                children: []
                            },
                            theme: {
                                template: 'avocado',
                                config: {}
                            },
                            layout: 'logicalStructure',
                            config: {},
                            view: null
                        },
                        mindMapConfig: {},
                        lang: 'zh',
                        localConfig: null
                    });
                }, 1000);
            });
        };
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 校验思维导图数据是否有效（避免在数据为空或无意义时保存）
        function isValidMindMapData(mindMapData) {
            if (!mindMapData) return false;
            const root = mindMapData.root;
            if (!root) return false;

            // 如果根节点有非空文本或存在子节点，则认为有效
            const hasText = root.data && typeof root.data.text === 'string' && root.data.text.trim() !== '';
            const hasChildren = Array.isArray(root.children) && root.children.length > 0;
            return hasText || hasChildren;
        }
        
        const setTakeOverAppMethods = data => {
            window.takeOverAppMethods = {};
            
            // 获取思维导图数据的函数
            window.takeOverAppMethods.getMindMapData = () => {
                return data.mindMapData;
            };
            
            // 保存思维导图数据的函数（带防抖）
            const saveMindMapDataDebounced = debounce((mindMapData) => {
                if (!isValidMindMapData(mindMapData)) {
                    console.warn('Skipped saving invalid or empty mindMapData');
                    return;
                }
                window.parent.postMessage(JSON.stringify({
                    event: 'save',
                    data: mindMapData
                }), '*');
            }, 500);
            
            window.takeOverAppMethods.saveMindMapData = mindMapData => {
                if (!isValidMindMapData(mindMapData)) {
                    console.warn('takeOverAppMethods.saveMindMapData: skipped invalid or empty data');
                    return;
                }
                saveMindMapDataDebounced(mindMapData);
            };
            
            // 获取思维导图配置
            window.takeOverAppMethods.getMindMapConfig = () => {
                return data.mindMapConfig;
            };
            
            // 保存思维导图配置
            window.takeOverAppMethods.saveMindMapConfig = config => {
                window.parent.postMessage(JSON.stringify({
                    event: 'save_config',
                    config: config
                }), '*');
            };
            
            // 获取语言的函数
            window.takeOverAppMethods.getLanguage = () => {
                return data.lang;
            };
            
            // 保存语言的函数
            window.takeOverAppMethods.saveLanguage = lang => {
                window.parent.postMessage(JSON.stringify({
                    event: 'save_language',
                    lang: lang
                }), '*');
            };
            
            // 获取本地配置的函数
            window.takeOverAppMethods.getLocalConfig = () => {
                return data.localConfig;
            };
            
            // 保存本地配置的函数
            window.takeOverAppMethods.saveLocalConfig = config => {
                window.parent.postMessage(JSON.stringify({
                    event: 'save_local_config',
                    config: config
                }), '*');
            };
        };
        
        window.onload = async () => {
            if (!window.takeOverApp) return;
            
            // 请求数据
            const data = await getDataFromParent();
            
            // 设置全局的方法
            setTakeOverAppMethods(data);
            
            // 手动保存函数（立即保存，不防抖）
            const manualSave = () => {
                if (window.mindMapInstance) {
                    try {
                        const mindMapData = window.mindMapInstance.getData(true);
                        if (!isValidMindMapData(mindMapData)) {
                            console.warn('Manual save skipped: invalid or empty mindMapData');
                            return;
                        }
                        window.parent.postMessage(JSON.stringify({
                            event: 'save',
                            data: mindMapData
                        }), '*');
                    } catch (err) {
                        console.error('Manual save error:', err);
                    }
                }
            };
            
            // 自动保存函数
            const autoSave = () => {
                if (window.mindMapInstance) {
                    try {
                        const mindMapData = window.mindMapInstance.getData(true);
                        if (!isValidMindMapData(mindMapData)) {
                            console.warn('Auto save skipped: invalid or empty mindMapData');
                            return;
                        }
                        window.parent.postMessage(JSON.stringify({
                            event: 'save',
                            data: mindMapData
                        }), '*');
                    } catch (err) {
                        console.error('Auto save error:', err);
                    }
                }
            };

            // 自动保存控制：仅在窗口聚焦且可见时运行
            let __autoSaveInterval = null;
            const startAutoSave = () => {
                if (__autoSaveInterval) return;
                // 只有在窗口聚焦并且文档可见时才启动定时器
                if (!document.hasFocus() || document.visibilityState !== 'visible') return;
                __autoSaveInterval = setInterval(autoSave, 60000);
                // 兼容旧代码中使用的引用
                window.autoSaveInterval = __autoSaveInterval;
            };
            const stopAutoSave = () => {
                if (__autoSaveInterval) {
                    clearInterval(__autoSaveInterval);
                    __autoSaveInterval = null;
                    window.autoSaveInterval = null;
                }
            };

            // 可见性变化处理器（单独命名以便移除监听）
            const __visibilityHandler = () => {
                if (document.visibilityState === 'visible') startAutoSave();
                else stopAutoSave();
            };

            // 监听 focus/blur/visibility，以便在窗口不活跃时停止自动保存
            window.addEventListener('focus', startAutoSave);
            window.addEventListener('blur', stopAutoSave);
            document.addEventListener('visibilitychange', __visibilityHandler);
            
            // 思维导图实例创建完成事件
            window.$bus.$on('app_inited', mindMap => {
                window.mindMapInstance = mindMap;
                window.parent.postMessage(JSON.stringify({
                    event: 'app_inited'
                }), '*');
                // 启动自动保存（仅在窗口聚焦且可见时）
                startAutoSave();

            });
            
            // 监听 Ctrl+S 快捷键
            document.addEventListener('keydown', (event) => {
                // Ctrl+S 或 Cmd+S (Mac)
                if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    event.preventDefault(); // 阻止浏览器默认保存行为
                    manualSave();
                }
            });
            
            // 监听来自父窗口的消息
            window.addEventListener('message', async (event) => {
                try {
                    const message = JSON.parse(event.data);
                    
                    if (message.action === 'export_image') {
                        if (window.mindMapInstance) {
                            try {
                                const type = message.type || 'png';
                                const exportData = await window.mindMapInstance.export(type, false, 'mindmap');
                                window.parent.postMessage(JSON.stringify({
                                    event: 'export_success',
                                    data: exportData,
                                    callbackId: message.callbackId
                                }), '*');
                            } catch (e) {
                                console.error('Export failed:', e);
                                window.parent.postMessage(JSON.stringify({
                                    event: 'export_error',
                                    error: e.message,
                                    callbackId: message.callbackId
                                }), '*');
                            }
                        } else {
                            console.error('mindMapInstance not available');
                        }
                    }
                } catch (err) {
                    // Ignore parse errors for non-JSON messages
                    if (err.message && !err.message.includes('JSON')) {
                        console.error('Message parse error:', err);
                    }
                }
            });
            
            // 实例化页面
            window.initApp();
            
            // 页面卸载时清除定时器并移除事件监听器
            window.addEventListener('beforeunload', () => {
                // 停止并清理自动保存
                try { stopAutoSave(); } catch (e) {}
                // 移除焦点/可见性监听器
                try { window.removeEventListener('focus', startAutoSave); } catch (e) {}
                try { window.removeEventListener('blur', stopAutoSave); } catch (e) {}
                try { document.removeEventListener('visibilitychange', __visibilityHandler); } catch (e) {}
            });
        };
    </script>
    <script src="dist/js/chunk-vendors.js"></script>
    <script src="dist/js/app.js"></script>
</body>
</html>