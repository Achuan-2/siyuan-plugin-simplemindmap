<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <link rel="icon" href="dist/logo.ico">
    <title>思维导图</title>
    <script>
        // 自定义静态资源的路径
        window.externalPublicPath = './dist/'
        // 接管应用
        window.takeOverApp = true
    </script>
    <link href="dist/css/chunk-vendors.css" rel="stylesheet">
    <link href="dist/css/app.css" rel="stylesheet">
</head>
<body>
    <noscript>
        <strong>We're sorry but thoughts doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <script>
        // 从父窗口获取数据
        const getDataFromParent = () => {
            return new Promise((resolve, reject) => {
                // 发送消息给父窗口请求数据
                window.parent.postMessage(JSON.stringify({
                    event: 'request_data'
                }), '*');
                
                // 监听父窗口的响应
                const messageHandler = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.event === 'init_data') {
                            window.removeEventListener('message', messageHandler);
                            resolve({
                                mindMapData: message.mindMapData || {
                                    root: {
                                        data: {
                                            text: '根节点'
                                        },
                                        children: []
                                    },
                                    theme: {
                                        template: 'lemonBubbles',
                                        config: {                                    // 图片显示的最大宽度
                                            imgMaxWidth: 350,
                                            // 图片显示的最大高度
                                            imgMaxHeight: 200,
                                            root:{
                                                shape: "rectangle"
                                            },
                                            second: {
                                                fontSize: 24,
                                                shape: "rectangle"
                                            },
                                            node: {
                                                fontSize: 24,
                                                borderColor: "#4D4D4D",
                                                borderWidth: 2
                                            }
                                        }
                                    },
                                    layout: 'logicalStructure',
                                    config: {},
                                    view: null
                                },
                                mindMapConfig: message.mindMapConfig || {},
                                lang: message.lang || 'zh',
                                localConfig: message.localConfig || null
                            });
                        }
                    } catch (err) {
                        console.error('Parse message error:', err);
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // 超时处理
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    resolve({
                        mindMapData: {
                            root: {
                                data: {
                                    text: '根节点'
                                },
                                children: []
                            },
                            theme: {
                                template: 'lemonBubbles',
                                config: {
                                    // 图片显示的最大宽度
                                    imgMaxWidth: 350,
                                    // 图片显示的最大高度
                                    imgMaxHeight: 200,
                                    root: {
                                        shape: "rectangle"
                                    },
                                    second: {
                                        fontSize: 24,
                                        shape: "rectangle"
                                    },
                                    node: {
                                        fontSize: 24,
                                        borderColor: "#4D4D4D",
                                        borderWidth: 2
                                    }
}
                            },
                            layout: 'logicalStructure',
                            config: {},
                            view: null
                        },
                        mindMapConfig: {},
                        lang: 'zh',
                        localConfig: null
                    });
                }, 1000);
            });
        };
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 校验思维导图数据是否有效（避免在数据为空或无意义时保存）
        function isValidMindMapData(mindMapData) {
            if (!mindMapData) return false;
            const root = mindMapData.root;
            if (!root) return false;

            // 如果根节点有非空文本或存在子节点，则认为有效
            const hasText = root.data && typeof root.data.text === 'string' && root.data.text.trim() !== '';
            const hasChildren = Array.isArray(root.children) && root.children.length > 0;
            return hasText || hasChildren;
        }
        
                // 检测用户是否正在输入（用于在输入时跳过自动保存，避免中断输入）
                function isUserTyping() {
                    try {
                        const active = document.activeElement;
                        if (!active) return false;
                        const tag = (active.tagName || '').toLowerCase();
                        if (tag === 'input' || tag === 'textarea') return true;
                        if (active.isContentEditable) return true;
                        // 检查是否有聚焦的 contenteditable 元素
                        if (document.querySelector('[contenteditable="true"]:focus')) return true;
                        // 如果 mindMapInstance 提供编辑状态检测方法，则优先使用（兼容性检测）
                        if (window.mindMapInstance && typeof window.mindMapInstance.isEditing === 'function') {
                            try {
                                if (window.mindMapInstance.isEditing()) return true;
                            } catch (e) {
                                // ignore
                            }
                        }
                        return false;
                    } catch (e) {
                        return false;
                    }
                }

                const setTakeOverAppMethods = data => {
            window.takeOverAppMethods = {};
            
            // 获取思维导图数据的函数
            window.takeOverAppMethods.getMindMapData = () => {
                return data.mindMapData;
            };
            
            // 保存思维导图数据的函数（带防抖）
            // 在防抖保存前检测是否正在输入，若是则跳过保存以避免打字中断
            const saveMindMapDataDebounced = debounce((mindMapData) => {
                if (isUserTyping()) {
                    console.warn('Skipped saving because user is typing');
                    return;
                }
                if (!isValidMindMapData(mindMapData)) {
                    console.warn('Skipped saving invalid or empty mindMapData');
                    return;
                }
                window.parent.postMessage(JSON.stringify({
                    event: 'save',
                    data: mindMapData
                }), '*');
            }, 500);
            
            window.takeOverAppMethods.saveMindMapData = mindMapData => {
                if (isUserTyping()) {
                    console.warn('takeOverAppMethods.saveMindMapData: skipped because user is typing');
                    return;
                }
                if (!isValidMindMapData(mindMapData)) {
                    console.warn('takeOverAppMethods.saveMindMapData: skipped invalid or empty data');
                    return;
                }
                saveMindMapDataDebounced(mindMapData);
            };
            
            // 获取思维导图配置
            window.takeOverAppMethods.getMindMapConfig = () => {
                return data.mindMapConfig;
            };
            
            // 保存思维导图配置
            window.takeOverAppMethods.saveMindMapConfig = config => {
                window.parent.postMessage(JSON.stringify({
                    event: 'save_config',
                    config: config
                }), '*');
            };
            
            // 获取语言的函数
            window.takeOverAppMethods.getLanguage = () => {
                return data.lang;
            };
            
            // 保存语言的函数
            window.takeOverAppMethods.saveLanguage = lang => {
                window.parent.postMessage(JSON.stringify({
                    event: 'save_language',
                    lang: lang
                }), '*');
            };
            
            // 获取本地配置的函数
            window.takeOverAppMethods.getLocalConfig = () => {
                return data.localConfig;
            };
            
            // 保存本地配置的函数
            window.takeOverAppMethods.saveLocalConfig = config => {
                window.parent.postMessage(JSON.stringify({
                    event: 'save_local_config',
                    config: config
                }), '*');
            };
        };
        
        window.onload = async () => {
            if (!window.takeOverApp) return;
            
            // 请求数据
            const data = await getDataFromParent();
            
            // 设置全局的方法
            setTakeOverAppMethods(data);
            
            // 禁用标签页切换
            const disableTabSwitching = () => {
                try {
                    const tabHeaders = window.parent.document.querySelectorAll('.layout-tab-bar li[data-type="tab-header"]');
                    tabHeaders.forEach((header) => {
                        header.style.pointerEvents = 'none';
                        header.style.opacity = '0.6';
                    });
                } catch (err) {
                    // 跨域访问可能失败，忽略错误
                    console.warn('Cannot disable tab switching (cross-origin):', err);
                }
            };
            
            // 启用标签页切换
            const enableTabSwitching = () => {
                try {
                    const tabHeaders = window.parent.document.querySelectorAll('.layout-tab-bar li[data-type="tab-header"]');
                    tabHeaders.forEach((header) => {
                        header.style.pointerEvents = '';
                        header.style.opacity = '';
                    });
                } catch (err) {
                    // 跨域访问可能失败，忽略错误
                    console.warn('Cannot enable tab switching (cross-origin):', err);
                }
            };
            
            // 手动保存函数（立即保存，不防抖）
            const manualSave = () => {
                if (window.mindMapInstance) {
                    try {
                        // 禁用标签页切换以防止保存过程中SVG尺寸计算错误
                        disableTabSwitching();
                        
                        const mindMapData = window.mindMapInstance.getData(true);
                        if (!isValidMindMapData(mindMapData)) {
                            console.warn('Manual save skipped: invalid or empty mindMapData');
                            return;
                        }
                        
                        window.parent.postMessage(JSON.stringify({
                            event: 'save',
                            data: mindMapData,
                            via: 'manual'
                        }), '*');
                    } catch (err) {
                        console.error('Manual save error:', err);
                        // 发生错误时也要重新启用标签页切换
                        enableTabSwitching();
                    }
                }
            };
            
            // 自动保存函数
            const autoSave = () => {
                if (window.mindMapInstance) {
                    try {
                        const mindMapData = window.mindMapInstance.getData(true);
                        if (!isValidMindMapData(mindMapData)) {
                            console.warn('Auto save skipped: invalid or empty mindMapData');
                            return;
                        }
                        window.parent.postMessage(JSON.stringify({
                            event: 'save',
                            data: mindMapData
                        }), '*');
                    } catch (err) {
                        console.error('Auto save error:', err);
                    }
                }
            };

            // 自动保存已取消：不再启动定时保存或监听窗口可见/聚焦状态
            
            // 思维导图实例创建完成事件
            window.$bus.$on('app_inited', mindMap => {
                window.mindMapInstance = mindMap;
                window.parent.postMessage(JSON.stringify({
                    event: 'app_inited'
                }), '*');
                // 自动保存已取消，保留手动保存功能

            });
            
            // 监听 Ctrl+S 快捷键
            document.addEventListener('keydown', (event) => {
                // Ctrl+S 或 Cmd+S (Mac)
                if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    event.preventDefault(); // 阻止浏览器默认保存行为
                    manualSave();
                }
            });
            
            // 监听来自父窗口的消息
            window.addEventListener('message', async (event) => {
                try {
                    const message = JSON.parse(event.data);
                    
                    if (message.action === 'export_image') {
                        if (window.mindMapInstance) {
                            try {
                                const type = message.type || 'png';
                                const exportData = await window.mindMapInstance.export(type, false, 'mindmap', false);
                                window.parent.postMessage(JSON.stringify({
                                    event: 'export_success',
                                    data: exportData,
                                    callbackId: message.callbackId
                                }), '*');
                                // 导出成功后延迟300ms再启用标签页切换
                                setTimeout(() => {
                                    enableTabSwitching();
                                }, 300);
                            } catch (e) {
                                console.error('Export failed:', e);
                                window.parent.postMessage(JSON.stringify({
                                    event: 'export_error',
                                    error: e.message,
                                    callbackId: message.callbackId
                                }), '*');
                                // 导出失败也要重新启用标签页切换
                                enableTabSwitching();
                            }
                        } else {
                            console.error('mindMapInstance not available');
                            enableTabSwitching();
                        }
                    }
                } catch (err) {
                    // Ignore parse errors for non-JSON messages
                    if (err.message && !err.message.includes('JSON')) {
                        console.error('Message parse error:', err);
                    }
                }
            });
            
            // 实例化页面
            window.initApp();
            
            // 页面卸载时清理（自动保存已取消，无需移除相关监听器）
            window.addEventListener('beforeunload', () => {
                // 自动保存已取消，无需清理定时器或可见性/焦点监听器
            });
        };
    </script>
    <script src="dist/js/chunk-vendors.js"></script>
    <script src="dist/js/app.js"></script>
</body>
</html>